"""
NPM Malware Scanner - Detect malicious files from recent supply chain attacks
Scans for indicators of compromise from shai-hulud and other npm malware campaigns

Author: Security Tools Project
Date: December 6, 2025
"""

import json
import os
from pathlib import Path
from typing import Dict, List, Set
from datetime import datetime


class MalwareScanner:
    """Scanner for npm supply chain attack indicators"""

    # Known malicious files from shai-hulud campaign
    MALICIOUS_FILES = [
        'bun_environment.js',
        'setup_bun.js',
        'cloud.json',
        'truffleSecrets.json',
        'contents.json',
        'environment.json',
        'trufflehog.exe',
        'trufflehog',
    ]

    # Malicious directories
    MALICIOUS_DIRS = [
        '.truffler-cache',
        '.truffler',
    ]

    # Malicious workflow files
    MALICIOUS_WORKFLOWS = [
        'discussion.yaml',
    ]

    # Suspicious scoped packages from shai-hulud
    SUSPICIOUS_SCOPES = [
        '@postman',
        '@posthog',
        '@asyncapi',
        '@ensdomains',
        '@zapier',
    ]

    # Suspicious preinstall script patterns
    SUSPICIOUS_PATTERNS = [
        'setup_bun.js',
        'bun_environment',
        'trufflehog',
        '.truffler',
    ]

    def __init__(self):
        self.findings: List[Dict] = []
        self.scanned_projects = 0
        self.infected_projects = 0

    def scan_directory(self, root_path: str) -> Dict:
        """Scan directory for malware indicators"""
        root = Path(root_path)

        print(f"\n[*] Scanning for npm malware indicators in: {root_path}")
        print(f"[*] Looking for shai-hulud campaign artifacts...\n")

        # Find all package.json files
        package_files = list(root.rglob('package.json'))

        # Filter out node_modules to avoid noise
        package_files = [
            f for f in package_files
            if 'node_modules' not in str(f) and '.npm' not in str(f)
        ]

        total = len(package_files)
        print(f"[*] Found {total} projects to scan\n")

        # Scan each project
        for pkg_file in package_files:
            self.scanned_projects += 1
            project_dir = pkg_file.parent
            self._scan_project(project_dir, pkg_file)

        return self._generate_report()

    def _scan_project(self, project_dir: Path, package_file: Path):
        """Scan individual project for malware"""
        indicators = []

        # Check for malicious files
        for malicious_file in self.MALICIOUS_FILES:
            if (project_dir / malicious_file).exists():
                indicators.append({
                    'type': 'malicious_file',
                    'indicator': malicious_file,
                    'path': str(project_dir / malicious_file),
                    'severity': 'CRITICAL'
                })

        # Check for malicious directories
        for malicious_dir in self.MALICIOUS_DIRS:
            if (project_dir / malicious_dir).is_dir():
                indicators.append({
                    'type': 'malicious_directory',
                    'indicator': malicious_dir,
                    'path': str(project_dir / malicious_dir),
                    'severity': 'CRITICAL'
                })

        # Check for malicious workflows
        workflows_dir = project_dir / '.github' / 'workflows'
        if workflows_dir.exists():
            for workflow_file in self.MALICIOUS_WORKFLOWS:
                if (workflows_dir / workflow_file).exists():
                    indicators.append({
                        'type': 'malicious_workflow',
                        'indicator': workflow_file,
                        'path': str(workflows_dir / workflow_file),
                        'severity': 'CRITICAL'
                    })

        # Check package.json for suspicious patterns
        try:
            with open(package_file, 'r', encoding='utf-8') as f:
                pkg_data = json.load(f)

            # Check scripts for suspicious patterns
            scripts = pkg_data.get('scripts', {})
            for script_name, script_cmd in scripts.items():
                for pattern in self.SUSPICIOUS_PATTERNS:
                    if pattern in script_cmd:
                        indicators.append({
                            'type': 'suspicious_script',
                            'indicator': f'{script_name}: {pattern}',
                            'path': str(package_file),
                            'severity': 'HIGH',
                            'script': script_cmd
                        })

            # Check dependencies for suspicious scopes
            all_deps = {}
            all_deps.update(pkg_data.get('dependencies', {}))
            all_deps.update(pkg_data.get('devDependencies', {}))

            for dep_name in all_deps.keys():
                for scope in self.SUSPICIOUS_SCOPES:
                    if dep_name.startswith(scope):
                        # Verify it's actually malicious (not legitimate package)
                        if not self._is_legitimate_package(dep_name):
                            indicators.append({
                                'type': 'suspicious_dependency',
                                'indicator': dep_name,
                                'path': str(package_file),
                                'severity': 'HIGH'
                            })

        except Exception as e:
            # Skip files that can't be parsed
            pass

        # Record findings
        if indicators:
            self.infected_projects += 1
            self.findings.append({
                'project': str(project_dir),
                'package_file': str(package_file),
                'indicators': indicators,
                'indicator_count': len(indicators)
            })

    def _is_legitimate_package(self, package_name: str) -> bool:
        """Check if package is legitimate despite suspicious scope"""
        # Known legitimate packages that use these scopes
        legitimate = {
            '@postman/newman',
            '@postman/tunnel-agent',
            '@asyncapi/parser',
            '@asyncapi/generator',
        }
        return package_name in legitimate

    def _generate_report(self) -> Dict:
        """Generate scan report"""
        critical_count = sum(
            1 for finding in self.findings
            for indicator in finding['indicators']
            if indicator['severity'] == 'CRITICAL'
        )

        high_count = sum(
            1 for finding in self.findings
            for indicator in finding['indicators']
            if indicator['severity'] == 'HIGH'
        )

        report = {
            'scan_timestamp': datetime.now().isoformat(),
            'total_projects_scanned': self.scanned_projects,
            'infected_projects': self.infected_projects,
            'clean_projects': self.scanned_projects - self.infected_projects,
            'total_indicators': critical_count + high_count,
            'critical_indicators': critical_count,
            'high_indicators': high_count,
            'findings': self.findings
        }

        return report

    def print_report(self, report: Dict):
        """Print formatted report"""
        print("\n" + "="*70)
        print("NPM MALWARE SCAN REPORT")
        print("="*70)
        print(f"Scan completed: {report['scan_timestamp']}")
        print(f"\nProjects scanned: {report['total_projects_scanned']}")
        print(f"Infected:         {report['infected_projects']}")
        print(f"Clean:            {report['clean_projects']}")
        print(f"\nTotal indicators: {report['total_indicators']}")
        print(f"  CRITICAL:       {report['critical_indicators']}")
        print(f"  HIGH:           {report['high_indicators']}")

        if report['infected_projects'] > 0:
            print("\n" + "="*70)
            print("INFECTED PROJECTS DETAILS")
            print("="*70)

            for finding in report['findings']:
                print(f"\n[!] {finding['project']}")
                print(f"    Indicators: {finding['indicator_count']}")

                for indicator in finding['indicators']:
                    severity_marker = "[!!!]" if indicator['severity'] == 'CRITICAL' else "[!!]"
                    print(f"    {severity_marker} {indicator['type']}: {indicator['indicator']}")
                    print(f"         Path: {indicator['path']}")
                    if 'script' in indicator:
                        print(f"         Script: {indicator['script']}")

        print("\n" + "="*70)

        if report['infected_projects'] > 0:
            print("\n[!!!] MALWARE DETECTED - IMMEDIATE ACTION REQUIRED!")
            print("\nRecommended actions:")
            print("1. Quarantine affected projects immediately")
            print("2. Remove all malicious files and directories")
            print("3. Review and remove suspicious dependencies")
            print("4. Check for data exfiltration (API keys, credentials)")
            print("5. Rotate all potentially compromised secrets")
            print("6. Run full antivirus scan")
            print("7. Review recent npm install logs")
        else:
            print("\n[OK] No malware indicators found")

    def save_report(self, report: Dict, output_file: str = None):
        """Save report to JSON file"""
        if output_file is None:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            output_file = f"malware_scan_report_{timestamp}.json"

        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2)

        print(f"\n[*] Report saved to: {output_file}")
        return output_file


def main():
    import sys

    if len(sys.argv) < 2:
        print("Usage: python malware_scanner.py <directory_path>")
        print("\nExample:")
        print("  python malware_scanner.py G:/")
        print("  python malware_scanner.py C:/projects")
        sys.exit(1)

    scan_path = sys.argv[1]

    if not os.path.exists(scan_path):
        print(f"Error: Path not found: {scan_path}")
        sys.exit(1)

    scanner = MalwareScanner()
    report = scanner.scan_directory(scan_path)
    scanner.print_report(report)
    scanner.save_report(report)


if __name__ == "__main__":
    main()
