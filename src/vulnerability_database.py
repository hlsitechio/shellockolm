"""
Comprehensive Vulnerability Database for Shellockolm
Tracks 30+ CVEs for npm, Node.js, React, Next.js, and related ecosystem

Last Updated: 2026-01-23
CVE Coverage: 2024-2026
"""

from dataclasses import dataclass, field
from typing import List, Optional, Dict, Set, Tuple
from enum import Enum
import re


class Severity(Enum):
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"


class VulnType(Enum):
    RCE = "Remote Code Execution"
    AUTH_BYPASS = "Authorization Bypass"
    PATH_TRAVERSAL = "Path Traversal"
    DOS = "Denial of Service"
    INFO_DISCLOSURE = "Information Disclosure"
    SUPPLY_CHAIN = "Supply Chain Attack"
    PERMISSION_BYPASS = "Permission Model Bypass"
    CODE_INJECTION = "Code Injection"


class ExploitDifficulty(Enum):
    TRIVIAL = "Trivial"      # Public PoC, one-liner
    EASY = "Easy"            # Well-documented, easy to replicate
    MODERATE = "Moderate"    # Requires specific conditions
    HARD = "Hard"            # Complex exploitation chain


@dataclass
class Vulnerability:
    """Represents a security vulnerability"""
    cve_id: str
    title: str
    severity: Severity
    cvss_score: float
    vuln_type: VulnType
    packages: List[str]
    affected_versions: List[str]
    patched_versions: Dict[str, str]
    description: str
    exploit_difficulty: ExploitDifficulty = ExploitDifficulty.MODERATE
    cwe: Optional[str] = None
    cvss_vector: Optional[str] = None
    references: List[str] = field(default_factory=list)
    discovered_date: Optional[str] = None
    cisa_kev: bool = False
    cisa_kev_date: Optional[str] = None
    public_poc: bool = False
    active_exploitation: bool = False
    requires_auth: bool = False
    platform: Optional[str] = None  # None = all, "Windows", "Linux"
    notes: Optional[str] = None
    detection_signatures: Dict[str, str] = field(default_factory=dict)


@dataclass
class MalwareCampaign:
    """Represents a supply chain attack or malware campaign"""
    name: str
    severity: Severity
    description: str
    affected_packages: List[str]
    malicious_versions: List[str] = field(default_factory=list)
    safe_versions: List[str] = field(default_factory=list)
    indicators: List[str] = field(default_factory=list)
    file_patterns: List[str] = field(default_factory=list)
    script_patterns: List[str] = field(default_factory=list)
    references: List[str] = field(default_factory=list)
    attack_date: Optional[str] = None
    cves: List[str] = field(default_factory=list)


class VulnerabilityDatabase:
    """Comprehensive database of 30+ known vulnerabilities"""

    # =========================================================================
    # REACT SERVER COMPONENTS VULNERABILITIES
    # =========================================================================
    REACT_RSC_VULNERABILITIES = [
        Vulnerability(
            cve_id="CVE-2025-55182",
            title="React Server Components RCE (React2Shell)",
            severity=Severity.CRITICAL,
            cvss_score=10.0,
            vuln_type=VulnType.RCE,
            cwe="CWE-502",
            cvss_vector="CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H",
            packages=[
                "react",
                "react-server-dom-webpack",
                "react-server-dom-parcel",
                "react-server-dom-turbopack"
            ],
            affected_versions=["19.0.0", "19.1.0", "19.1.1", "19.2.0"],
            patched_versions={
                "19.0.0": "19.0.1",
                "19.1.0": "19.1.2",
                "19.1.1": "19.1.2",
                "19.2.0": "19.2.1",
            },
            description="Unsafe deserialization of payloads from HTTP requests to Server Function endpoints allows unauthenticated RCE",
            exploit_difficulty=ExploitDifficulty.TRIVIAL,
            discovered_date="2025-11-29",
            cisa_kev=True,
            cisa_kev_date="2025-12-05",
            public_poc=True,
            active_exploitation=True,
            references=[
                "https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components",
                "https://nvd.nist.gov/vuln/detail/CVE-2025-55182",
            ],
            detection_signatures={
                "http_header": "rsc: 1",
                "content_type": "text/x-component",
                "header": "Next-Router-State-Tree",
            },
            notes="CISA KEV - Patch immediately. Nation-state exploitation confirmed (PRC-linked actors)."
        ),
        Vulnerability(
            cve_id="CVE-2025-66478",
            title="Next.js Server Components RCE (Vercel Advisory)",
            severity=Severity.CRITICAL,
            cvss_score=10.0,
            vuln_type=VulnType.RCE,
            packages=["next"],
            affected_versions=[
                "15.0.0", "15.0.1", "15.0.2", "15.0.3", "15.0.4",
                "15.1.0", "15.1.1", "15.1.2", "15.1.3", "15.1.4", "15.1.5", "15.1.6", "15.1.7", "15.1.8",
                "15.2.0", "15.2.1", "15.2.2", "15.2.3", "15.2.4", "15.2.5",
                "15.3.0", "15.3.1", "15.3.2", "15.3.3", "15.3.4", "15.3.5",
                "15.4.0", "15.4.1", "15.4.2", "15.4.3", "15.4.4", "15.4.5", "15.4.6", "15.4.7",
                "15.5.0", "15.5.1", "15.5.2", "15.5.3", "15.5.4", "15.5.5", "15.5.6",
                "16.0.0", "16.0.1", "16.0.2", "16.0.3", "16.0.4", "16.0.5", "16.0.6",
            ],
            patched_versions={
                "15.0.x": "15.0.5",
                "15.1.x": "15.1.9",
                "15.2.x": "15.2.6",
                "15.3.x": "15.3.6",
                "15.4.x": "15.4.8",
                "15.5.x": "15.5.7",
                "16.0.x": "16.0.7",
            },
            description="Duplicate of CVE-2025-55182 for Next.js - React Server Components deserialization RCE",
            exploit_difficulty=ExploitDifficulty.TRIVIAL,
            discovered_date="2025-12-03",
            public_poc=True,
            active_exploitation=True,
            references=[
                "https://github.com/vercel/next.js/security/advisories/GHSA-9qr9-h5gf-34mp",
                "https://nextjs.org/blog/CVE-2025-66478",
            ],
            notes="Same root cause as CVE-2025-55182. Vercel deployments patched automatically."
        ),
        Vulnerability(
            cve_id="CVE-2025-55183",
            title="React Server Components Source Code Exposure",
            severity=Severity.MEDIUM,
            cvss_score=5.3,
            vuln_type=VulnType.INFO_DISCLOSURE,
            packages=[
                "react-server-dom-webpack",
                "react-server-dom-parcel",
                "react-server-dom-turbopack"
            ],
            affected_versions=["19.0.0-19.2.2"],
            patched_versions={
                "19.0.x": "19.0.3",
                "19.1.x": "19.1.4",
                "19.2.x": "19.2.3",
            },
            description="Server Functions can be manipulated to return compiled source code via .toString()",
            exploit_difficulty=ExploitDifficulty.EASY,
            public_poc=True,
            references=[]
        ),
        Vulnerability(
            cve_id="CVE-2025-55184",
            title="React Server Components DoS (Infinite Loop)",
            severity=Severity.HIGH,
            cvss_score=7.5,
            vuln_type=VulnType.DOS,
            packages=[
                "react-server-dom-webpack",
                "react-server-dom-parcel",
                "react-server-dom-turbopack"
            ],
            affected_versions=["19.0.0", "19.0.1", "19.1.0", "19.1.1", "19.2.0", "19.2.1"],
            patched_versions={
                "19.0.x": "19.0.2",
                "19.1.x": "19.1.2",
                "19.2.x": "19.2.2",
            },
            description="Malicious HTTP requests cause infinite loops and CPU exhaustion",
            exploit_difficulty=ExploitDifficulty.EASY,
            notes="Incomplete fix - see CVE-2025-67779"
        ),
        Vulnerability(
            cve_id="CVE-2025-67779",
            title="React Server Components DoS (Incomplete Fix)",
            severity=Severity.HIGH,
            cvss_score=7.5,
            vuln_type=VulnType.DOS,
            packages=[
                "react-server-dom-webpack",
                "react-server-dom-parcel",
                "react-server-dom-turbopack"
            ],
            affected_versions=["19.0.2", "19.1.3", "19.2.2"],
            patched_versions={
                "19.0.x": "19.0.3",
                "19.1.x": "19.1.4",
                "19.2.x": "19.2.3",
            },
            description="Incomplete fix for CVE-2025-55184 DoS vulnerability",
            exploit_difficulty=ExploitDifficulty.EASY
        ),
    ]

    # =========================================================================
    # NEXT.JS VULNERABILITIES
    # =========================================================================
    NEXTJS_VULNERABILITIES = [
        Vulnerability(
            cve_id="CVE-2025-29927",
            title="Next.js Middleware Authorization Bypass",
            severity=Severity.CRITICAL,
            cvss_score=9.1,
            vuln_type=VulnType.AUTH_BYPASS,
            packages=["next"],
            affected_versions=[
                # Ranges represented as individual common versions
                "11.1.4", "12.0.0", "12.1.0", "12.2.0", "12.3.0", "12.3.4",
                "13.0.0", "13.1.0", "13.2.0", "13.3.0", "13.4.0", "13.5.0", "13.5.6",
                "14.0.0", "14.1.0", "14.2.0", "14.2.24",
                "15.0.0", "15.1.0", "15.2.0", "15.2.2",
            ],
            patched_versions={
                "12.x": "12.3.5",
                "13.x": "13.5.7",
                "14.x": "14.2.25",
                "15.x": "15.2.3",
            },
            description="x-middleware-subrequest header injection bypasses all middleware authorization checks",
            exploit_difficulty=ExploitDifficulty.TRIVIAL,
            public_poc=True,
            references=[
                "https://securitylabs.datadoghq.com/articles/nextjs-middleware-auth-bypass/",
                "https://projectdiscovery.io/blog/nextjs-middleware-authorization-bypass",
            ],
            detection_signatures={
                "test_header": "x-middleware-subrequest: 1",
                "path_pattern": "/_next/static/",
                "powered_by": "X-Powered-By: Next.js",
            },
            notes="Vercel deployments auto-protected. Self-hosted apps vulnerable. Easy bug bounty target."
        ),
    ]

    # =========================================================================
    # N8N WORKFLOW AUTOMATION VULNERABILITIES
    # =========================================================================
    N8N_VULNERABILITIES = [
        Vulnerability(
            cve_id="CVE-2026-21858",
            title="n8n Unauthenticated RCE (Ni8mare)",
            severity=Severity.CRITICAL,
            cvss_score=10.0,
            vuln_type=VulnType.RCE,
            packages=["n8n"],
            affected_versions=["<1.121.0"],
            patched_versions={"<1.121.0": "1.121.0"},
            description="Content-Type confusion in Form Webhooks enables arbitrary file read, auth bypass, and RCE",
            exploit_difficulty=ExploitDifficulty.TRIVIAL,
            public_poc=True,
            requires_auth=False,
            references=[
                "https://orca.security/resources/blog/cve-2026-21858-n8n-rce-vulnerability/",
                "https://www.cyera.com/research-labs/ni8mare-unauthenticated-remote-code-execution-in-n8n-cve-2026-21858",
            ],
            detection_signatures={
                "webhook_path": "/webhook/",
                "test_path": "/webhook-test/",
                "form_path": "/form/",
                "header": "X-n8n-webhook-id",
            },
            notes="~100,000 exposed servers. Unauthenticated - extremely high risk."
        ),
        Vulnerability(
            cve_id="CVE-2025-68613",
            title="n8n Authenticated Expression Injection RCE",
            severity=Severity.CRITICAL,
            cvss_score=9.9,
            vuln_type=VulnType.RCE,
            packages=["n8n-workflow", "n8n"],
            affected_versions=["0.211.0-1.120.3", "1.121.0", "1.122.0-RC"],
            patched_versions={
                "1.120.x": "1.120.4",
                "1.121.x": "1.121.1",
                "1.122.x": "1.122.0",
            },
            description="Expression injection via insufficient sandbox isolation - access to Node.js global object",
            exploit_difficulty=ExploitDifficulty.EASY,
            public_poc=True,
            requires_auth=True,
            references=[
                "https://nvd.nist.gov/vuln/detail/CVE-2025-68613",
                "https://github.com/n8n-io/n8n/security/advisories/GHSA-v98v-ff95-f3cp",
            ],
            notes="Requires authenticated user with workflow creation permissions."
        ),
        Vulnerability(
            cve_id="CVE-2025-68668",
            title="n8n Python Code Node RCE",
            severity=Severity.HIGH,
            cvss_score=8.0,
            vuln_type=VulnType.RCE,
            packages=["@n8n/config", "n8n"],
            affected_versions=["<1.120.0"],
            patched_versions={"<1.120.0": "1.120.0"},
            description="Insufficient isolation in Python Code Node using Pyodide",
            exploit_difficulty=ExploitDifficulty.MODERATE,
            requires_auth=True
        ),
    ]

    # =========================================================================
    # NODE.JS RUNTIME VULNERABILITIES
    # =========================================================================
    NODEJS_VULNERABILITIES = [
        Vulnerability(
            cve_id="CVE-2025-59465",
            title="Node.js HTTP/2 Server Crash",
            severity=Severity.HIGH,
            cvss_score=7.5,
            vuln_type=VulnType.DOS,
            packages=["node"],
            affected_versions=["18.x", "20.x", "22.x", "24.x", "25.x"],
            patched_versions={
                "20.x": "20.20.0",
                "22.x": "22.22.0",
                "24.x": "24.13.0",
                "25.x": "25.3.0",
            },
            description="HTTP/2 server crashes with malformed HEADERS frame",
            exploit_difficulty=ExploitDifficulty.EASY,
            discovered_date="2026-01-13",
            references=["https://nodejs.org/en/blog/vulnerability/december-2025-security-releases"]
        ),
        Vulnerability(
            cve_id="CVE-2025-59464",
            title="Node.js TLS Memory Leak DoS",
            severity=Severity.MEDIUM,
            cvss_score=6.5,
            vuln_type=VulnType.DOS,
            packages=["node"],
            affected_versions=["20.x", "22.x", "24.x", "25.x"],
            patched_versions={
                "20.x": "20.20.0",
                "22.x": "22.22.0",
                "24.x": "24.13.0",
                "25.x": "25.3.0",
            },
            description="Memory leak in TLS client certificate processing enables remote DoS",
            exploit_difficulty=ExploitDifficulty.MODERATE
        ),
        Vulnerability(
            cve_id="CVE-2025-59466",
            title="Node.js async_hooks Stack Exhaustion",
            severity=Severity.MEDIUM,
            cvss_score=6.5,
            vuln_type=VulnType.DOS,
            packages=["node"],
            affected_versions=["20.x", "22.x", "24.x", "25.x"],
            patched_versions={
                "20.x": "20.20.0",
                "22.x": "22.22.0",
                "24.x": "24.13.0",
                "25.x": "25.3.0",
            },
            description="Uncatchable 'Maximum call stack size exceeded' error via async_hooks crashes process",
            exploit_difficulty=ExploitDifficulty.MODERATE,
            notes="Requires application to use async_hooks"
        ),
        Vulnerability(
            cve_id="CVE-2025-27210",
            title="Node.js Windows Path Traversal (Device Names)",
            severity=Severity.HIGH,
            cvss_score=7.0,
            vuln_type=VulnType.PATH_TRAVERSAL,
            cwe="CWE-22",
            packages=["node"],
            affected_versions=["20.x", "22.x", "24.x"],
            patched_versions={"all": "July 2025 security release"},
            description="Windows device names (CON, PRN, AUX, NUL) bypass path.join() normalization",
            exploit_difficulty=ExploitDifficulty.EASY,
            platform="Windows",
            notes="Incomplete fix for CVE-2025-23084"
        ),
        Vulnerability(
            cve_id="CVE-2025-23084",
            title="Node.js Windows Drive Name Path Traversal",
            severity=Severity.MEDIUM,
            cvss_score=5.6,
            vuln_type=VulnType.PATH_TRAVERSAL,
            cwe="CWE-22",
            packages=["node"],
            affected_versions=["18.x", "20.x", "22.x", "23.x"],
            patched_versions={},
            description="Improper handling of drive names on Windows in path.join()",
            exploit_difficulty=ExploitDifficulty.EASY,
            platform="Windows"
        ),
        Vulnerability(
            cve_id="CVE-2024-21891",
            title="Node.js Permission Model Bypass",
            severity=Severity.HIGH,
            cvss_score=8.8,
            vuln_type=VulnType.PERMISSION_BYPASS,
            packages=["node"],
            affected_versions=["20.0.0-20.11.0", "21.0.0-21.6.1"],
            patched_versions={
                "20.x": "20.11.1",
                "21.x": "21.6.2",
            },
            description="Path normalization functions can be overwritten leading to filesystem permission bypass",
            exploit_difficulty=ExploitDifficulty.MODERATE,
            notes="Affects experimental permission model"
        ),
        Vulnerability(
            cve_id="CVE-2025-55130",
            title="Node.js Symlink Permission Bypass",
            severity=Severity.HIGH,
            cvss_score=7.5,
            vuln_type=VulnType.PERMISSION_BYPASS,
            packages=["node"],
            affected_versions=["20.x", "22.x", "24.x", "25.x"],
            patched_versions={
                "20.x": "20.20.0",
                "22.x": "22.22.0",
                "24.x": "24.13.0",
                "25.x": "25.3.0",
            },
            description="Crafted symlinks bypass --allow-fs-read and --allow-fs-write restrictions",
            exploit_difficulty=ExploitDifficulty.MODERATE
        ),
        Vulnerability(
            cve_id="CVE-2026-21636",
            title="Node.js Unix Domain Socket Permission Bypass",
            severity=Severity.MEDIUM,
            cvss_score=6.0,
            vuln_type=VulnType.PERMISSION_BYPASS,
            packages=["node"],
            affected_versions=["20.x", "22.x", "24.x", "25.x"],
            patched_versions={
                "20.x": "20.20.0",
                "22.x": "22.22.0",
                "24.x": "24.13.0",
                "25.x": "25.3.0",
            },
            description="Unix Domain Socket connections bypass --allow-net restrictions",
            exploit_difficulty=ExploitDifficulty.MODERATE,
            platform="Linux"
        ),
        Vulnerability(
            cve_id="CVE-2025-55132",
            title="Node.js fs.futimes() Permission Bypass",
            severity=Severity.LOW,
            cvss_score=3.5,
            vuln_type=VulnType.PERMISSION_BYPASS,
            packages=["node"],
            affected_versions=["20.x", "22.x", "24.x", "25.x"],
            patched_versions={
                "20.x": "20.20.0",
                "22.x": "22.22.0",
                "24.x": "24.13.0",
                "25.x": "25.3.0",
            },
            description="fs.futimes() bypasses read-only permission model",
            exploit_difficulty=ExploitDifficulty.MODERATE
        ),
    ]

    # =========================================================================
    # NPM PACKAGE VULNERABILITIES
    # =========================================================================
    NPM_PACKAGE_VULNERABILITIES = [
        Vulnerability(
            cve_id="CVE-2024-21534",
            title="jsonpath-plus Remote Code Execution",
            severity=Severity.CRITICAL,
            cvss_score=9.8,
            vuln_type=VulnType.RCE,
            packages=["jsonpath-plus"],
            affected_versions=["<10.2.0"],
            patched_versions={"<10.2.0": "10.2.0"},
            description="Improper input sanitization and unsafe vm module usage allows arbitrary code execution",
            exploit_difficulty=ExploitDifficulty.TRIVIAL,
            public_poc=True,
            notes="Versions 10.0.0-10.1.0 had incomplete fixes"
        ),
        Vulnerability(
            cve_id="CVE-2025-1302",
            title="jsonpath-plus RCE (Incomplete Fix)",
            severity=Severity.CRITICAL,
            cvss_score=9.8,
            vuln_type=VulnType.RCE,
            packages=["jsonpath-plus"],
            affected_versions=["10.0.0", "10.1.0"],
            patched_versions={"10.x": "10.2.0"},
            description="Incomplete fix for CVE-2024-21534 allows continued RCE exploitation",
            exploit_difficulty=ExploitDifficulty.TRIVIAL,
            public_poc=True
        ),
        Vulnerability(
            cve_id="CVE-2024-21508",
            title="mysql2 Remote Code Execution",
            severity=Severity.CRITICAL,
            cvss_score=9.8,
            vuln_type=VulnType.RCE,
            cwe="CWE-94",
            cvss_vector="CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
            packages=["mysql2"],
            affected_versions=["<3.9.4"],
            patched_versions={"<3.9.4": "3.9.4"},
            description="Improper validation in readCodeFor function via supportBigNumbers/bigNumberStrings params",
            exploit_difficulty=ExploitDifficulty.EASY
        ),
        Vulnerability(
            cve_id="CVE-2024-45590",
            title="body-parser Denial of Service",
            severity=Severity.HIGH,
            cvss_score=7.5,
            vuln_type=VulnType.DOS,
            cwe="CWE-405",
            cvss_vector="CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
            packages=["body-parser"],
            affected_versions=["<1.20.3"],
            patched_versions={"<1.20.3": "1.20.3"},
            description="DoS when URL encoding enabled via specially crafted payloads",
            exploit_difficulty=ExploitDifficulty.EASY,
            discovered_date="2024-09-10"
        ),
        Vulnerability(
            cve_id="CVE-2025-48997",
            title="multer Denial of Service",
            severity=Severity.CRITICAL,
            cvss_score=9.0,
            vuln_type=VulnType.DOS,
            packages=["multer"],
            affected_versions=["1.4.4-lts.1", "<2.0.1"],
            patched_versions={"<2.0.1": "2.0.1"},
            description="Empty field names in upload requests cause unhandled exceptions and server crash",
            exploit_difficulty=ExploitDifficulty.EASY
        ),
        Vulnerability(
            cve_id="CVE-2025-47944",
            title="multer Multiple Vulnerabilities",
            severity=Severity.HIGH,
            cvss_score=7.5,
            vuln_type=VulnType.DOS,
            packages=["multer", "@nestjs/platform-express"],
            affected_versions=["1.4.4-lts.1"],
            patched_versions={"1.4.4-lts.1": "2.0.0"},
            description="Multiple security issues in multer affecting NestJS apps",
            exploit_difficulty=ExploitDifficulty.MODERATE
        ),
        Vulnerability(
            cve_id="CVE-2024-34344",
            title="Nuxt.js Test Mode RCE",
            severity=Severity.HIGH,
            cvss_score=8.0,
            vuln_type=VulnType.RCE,
            packages=["nuxt"],
            affected_versions=["<3.12.4"],
            patched_versions={"<3.12.4": "3.12.4"},
            description="Insufficient validation in NuxtTestComponentWrapper path parameter allows RCE via malicious web pages",
            exploit_difficulty=ExploitDifficulty.MODERATE,
            notes="Requires test mode to be enabled"
        ),
        Vulnerability(
            cve_id="CVE-2024-13059",
            title="AnythingLLM Path Traversal to RCE",
            severity=Severity.HIGH,
            cvss_score=7.5,
            vuln_type=VulnType.PATH_TRAVERSAL,
            packages=["AnythingLLM"],
            affected_versions=["<1.3.1"],
            patched_versions={"<1.3.1": "1.3.1"},
            description="Improper handling of non-ASCII filenames in multer enables path traversal leading to RCE",
            exploit_difficulty=ExploitDifficulty.MODERATE,
            requires_auth=True,
            notes="Requires Manager or Admin role"
        ),
        Vulnerability(
            cve_id="CVE-2026-21440",
            title="AdonisJS Bodyparser Path Traversal",
            severity=Severity.CRITICAL,
            cvss_score=9.2,
            vuln_type=VulnType.PATH_TRAVERSAL,
            packages=["@adonisjs/bodyparser"],
            affected_versions=["<9.0.0"],
            patched_versions={"<9.0.0": "9.0.0"},
            description="Crafted filenames bypass sanitization in MultipartFile.move() allowing arbitrary file write",
            exploit_difficulty=ExploitDifficulty.EASY
        ),
    ]

    # =========================================================================
    # SUPPLY CHAIN ATTACKS
    # =========================================================================
    SUPPLY_CHAIN_VULNERABILITIES = [
        Vulnerability(
            cve_id="CVE-2025-54313",
            title="eslint-config-prettier Supply Chain Attack",
            severity=Severity.HIGH,
            cvss_score=7.5,
            vuln_type=VulnType.SUPPLY_CHAIN,
            packages=[
                "eslint-config-prettier",
                "eslint-plugin-prettier",
                "synckit",
                "@pkgr/core",
                "napi-postinstall"
            ],
            affected_versions=["8.10.1", "9.1.1", "10.1.6", "10.1.7"],
            patched_versions={
                "8.x": "8.10.2",
                "9.x": "9.1.2",
                "10.x": "10.1.8",
            },
            description="Maintainer account compromise via phishing. Malicious DLL payload (Scavenger) for Windows",
            exploit_difficulty=ExploitDifficulty.TRIVIAL,
            platform="Windows",
            discovered_date="2025-07-19",
            notes="30M+ weekly downloads. Windows malware distribution.",
            references=["https://www.endorlabs.com/learn/cve-2025-54313-eslint-config-prettier-compromise"]
        ),
    ]

    # =========================================================================
    # MALWARE CAMPAIGNS
    # =========================================================================
    MALWARE_CAMPAIGNS = [
        MalwareCampaign(
            name="Shai-Hulud",
            severity=Severity.CRITICAL,
            description="Self-replicating npm worm that steals credentials and propagates via compromised npm tokens",
            affected_packages=[
                "@postman/security-helpers",
                "@posthog/plugin-geoip",
                "@asyncapi/openapi-schema-parser",
                "@ensdomains/content-hash",
                "@zapier/secret-scrubber",
            ],
            indicators=[
                "bun_environment.js",
                "setup_bun.js",
                "cloud.json",
                "truffleSecrets.json",
                ".truffler-cache",
                ".truffler",
                "trufflehog",
            ],
            file_patterns=[
                r"bun_environment\.js$",
                r"setup_bun\.js$",
                r"\.truffler-cache",
                r"truffleSecrets\.json$",
            ],
            script_patterns=[
                r"preinstall.*curl.*\|.*sh",
                r"postinstall.*wget",
                r"preinstall.*base64.*-d",
                r"install.*eval.*\$\(",
                r"npm.*token",
                r"github\.com.*Shai-Hulud",
            ],
            attack_date="2025-11",
            references=[
                "https://www.cisa.gov/news-events/alerts/2025/09/23/widespread-supply-chain-compromise-impacting-npm-ecosystem",
                "https://unit42.paloaltonetworks.com/npm-supply-chain-attack/",
                "https://blog.checkpoint.com/research/shai-hulud-2-0-inside-the-second-coming-the-most-aggressive-npm-supply-chain-attack-of-2025/",
            ],
            cves=["CVE-2025-10894", "CVE-2025-59037", "CVE-2025-59140", "CVE-2025-59143",
                  "CVE-2025-59162", "CVE-2025-59142", "CVE-2025-59144", "CVE-2025-59330",
                  "CVE-2025-59331", "CVE-2025-59141"]
        ),
        MalwareCampaign(
            name="Shai-Hulud 2.0 (The Second Coming)",
            severity=Severity.CRITICAL,
            description="Second wave attack: 25,000+ repos, 350+ users compromised in hours. Uses preinstall hooks.",
            affected_packages=[],  # Dynamically targets many packages
            indicators=[
                "dead man's switch mechanism",
                "preinstall hook abuse",
            ],
            script_patterns=[
                r"preinstall.*--ignore-scripts",
                r"npm.*run.*--ignore-scripts=false",
            ],
            attack_date="2025-11-21",
            references=[
                "https://www.wiz.io/blog/shai-hulud-2-0-ongoing-supply-chain-attack",
                "https://www.microsoft.com/en-us/security/blog/2025/12/09/shai-hulud-2-0-guidance-for-detecting-investigating-and-defending-against-the-supply-chain-attack/",
            ]
        ),
    ]

    # =========================================================================
    # DETECTION SIGNATURES FOR LIVE RECON
    # =========================================================================
    DETECTION_SIGNATURES = {
        "react_rsc": {
            "headers": ["rsc: 1", "Next-Router-State-Tree"],
            "content_type": "text/x-component",
            "paths": ["/_rsc/", "/api/"],
        },
        "nextjs": {
            "headers": ["X-Powered-By: Next.js"],
            "paths": ["/_next/static/", "/_next/data/"],
            "files": ["next.config.js", "next.config.mjs"],
        },
        "n8n": {
            "paths": ["/webhook/", "/webhook-test/", "/form/"],
            "headers": ["X-n8n-webhook-id"],
        },
        "express": {
            "headers": ["X-Powered-By: Express"],
        },
        "nodejs": {
            "headers": ["Server: Node.js"],
        },
    }

    # =========================================================================
    # HELPER METHODS
    # =========================================================================

    @classmethod
    def get_all_vulnerabilities(cls) -> List[Vulnerability]:
        """Get all vulnerabilities from all categories"""
        return (
            cls.REACT_RSC_VULNERABILITIES +
            cls.NEXTJS_VULNERABILITIES +
            cls.N8N_VULNERABILITIES +
            cls.NODEJS_VULNERABILITIES +
            cls.NPM_PACKAGE_VULNERABILITIES +
            cls.SUPPLY_CHAIN_VULNERABILITIES
        )

    @classmethod
    def get_critical_vulnerabilities(cls) -> List[Vulnerability]:
        """Get only CRITICAL severity vulnerabilities"""
        return [v for v in cls.get_all_vulnerabilities() if v.severity == Severity.CRITICAL]

    @classmethod
    def get_active_exploits(cls) -> List[Vulnerability]:
        """Get vulnerabilities with active exploitation"""
        return [v for v in cls.get_all_vulnerabilities() if v.active_exploitation]

    @classmethod
    def get_cisa_kev(cls) -> List[Vulnerability]:
        """Get vulnerabilities in CISA Known Exploited Vulnerabilities catalog"""
        return [v for v in cls.get_all_vulnerabilities() if v.cisa_kev]

    @classmethod
    def get_by_package(cls, package_name: str) -> List[Vulnerability]:
        """Get vulnerabilities affecting a specific package"""
        return [v for v in cls.get_all_vulnerabilities() if package_name in v.packages]

    @classmethod
    def get_by_cve(cls, cve_id: str) -> Optional[Vulnerability]:
        """Get a specific vulnerability by CVE ID"""
        for v in cls.get_all_vulnerabilities():
            if v.cve_id == cve_id:
                return v
        return None

    @classmethod
    def check_version(cls, package: str, version: str) -> List[Vulnerability]:
        """Check if a package version has known vulnerabilities"""
        clean_version = version.lstrip("^~>=<").split()[0].strip()
        vulnerabilities = []

        for vuln in cls.get_by_package(package):
            # Check exact version match
            if clean_version in vuln.affected_versions:
                vulnerabilities.append(vuln)
                continue

            # Check version ranges (e.g., "<3.9.4", "19.0.0-19.2.2")
            for affected in vuln.affected_versions:
                if cls._version_in_range(clean_version, affected):
                    vulnerabilities.append(vuln)
                    break

        return vulnerabilities

    @classmethod
    def _version_in_range(cls, version: str, range_spec: str) -> bool:
        """Check if a version matches a range specification"""
        try:
            from packaging.version import Version, parse
            v = parse(version)

            # Handle "<X.Y.Z" format
            if range_spec.startswith("<"):
                return v < parse(range_spec[1:])

            # Handle ">X.Y.Z" format
            if range_spec.startswith(">"):
                return v > parse(range_spec[1:])

            # Handle "X.Y.Z-A.B.C" range format
            if "-" in range_spec and not range_spec.startswith("-"):
                parts = range_spec.split("-")
                if len(parts) == 2:
                    return parse(parts[0]) <= v <= parse(parts[1])

            # Handle "X.x" wildcard format (e.g., "20.x")
            if ".x" in range_spec:
                major = range_spec.split(".")[0]
                return version.startswith(f"{major}.")

        except Exception:
            pass

        return False

    @classmethod
    def get_patched_version(cls, package: str, current_version: str, cve_id: str) -> Optional[str]:
        """Get the recommended patched version for a vulnerable package"""
        vuln = cls.get_by_cve(cve_id)
        if not vuln or package not in vuln.packages:
            return None

        clean_version = current_version.lstrip("^~>=<").split()[0]

        # Direct match
        if clean_version in vuln.patched_versions:
            return vuln.patched_versions[clean_version]

        # Range match (e.g., "15.0.x" -> "15.0.5")
        parts = clean_version.split(".")
        if len(parts) >= 2:
            for range_key in [f"{parts[0]}.{parts[1]}.x", f"{parts[0]}.x"]:
                if range_key in vuln.patched_versions:
                    return vuln.patched_versions[range_key]

            # Check generic keys like "<3.9.4"
            for key, patched in vuln.patched_versions.items():
                if key.startswith("<") and cls._version_in_range(clean_version, key):
                    return patched

        return None

    @classmethod
    def get_summary(cls) -> Dict:
        """Get a summary of the vulnerability database"""
        all_vulns = cls.get_all_vulnerabilities()
        return {
            "total_cves": len(all_vulns),
            "critical": len([v for v in all_vulns if v.severity == Severity.CRITICAL]),
            "high": len([v for v in all_vulns if v.severity == Severity.HIGH]),
            "medium": len([v for v in all_vulns if v.severity == Severity.MEDIUM]),
            "low": len([v for v in all_vulns if v.severity == Severity.LOW]),
            "active_exploitation": len(cls.get_active_exploits()),
            "cisa_kev": len(cls.get_cisa_kev()),
            "public_poc": len([v for v in all_vulns if v.public_poc]),
            "malware_campaigns": len(cls.MALWARE_CAMPAIGNS),
            "categories": {
                "react_rsc": len(cls.REACT_RSC_VULNERABILITIES),
                "nextjs": len(cls.NEXTJS_VULNERABILITIES),
                "n8n": len(cls.N8N_VULNERABILITIES),
                "nodejs": len(cls.NODEJS_VULNERABILITIES),
                "npm_packages": len(cls.NPM_PACKAGE_VULNERABILITIES),
                "supply_chain": len(cls.SUPPLY_CHAIN_VULNERABILITIES),
            }
        }

    @classmethod
    def get_bug_bounty_targets(cls) -> List[Vulnerability]:
        """Get high-value bug bounty targets - trivial exploitation with public PoCs"""
        return [
            v for v in cls.get_all_vulnerabilities()
            if v.exploit_difficulty in [ExploitDifficulty.TRIVIAL, ExploitDifficulty.EASY]
            and v.severity in [Severity.CRITICAL, Severity.HIGH]
            and not v.requires_auth
        ]


# Backwards compatibility aliases
def get_all_react_vulnerabilities() -> List[Vulnerability]:
    return VulnerabilityDatabase.REACT_RSC_VULNERABILITIES

def get_all_nextjs_vulnerabilities() -> List[Vulnerability]:
    return VulnerabilityDatabase.NEXTJS_VULNERABILITIES + [
        v for v in VulnerabilityDatabase.REACT_RSC_VULNERABILITIES
        if "next" in str(v.packages).lower()
    ]

def check_react_version(version: str) -> List[Vulnerability]:
    return VulnerabilityDatabase.check_version("react", version)

def check_nextjs_version(version: str) -> List[Vulnerability]:
    return VulnerabilityDatabase.check_version("next", version)


if __name__ == "__main__":
    # Print database summary
    summary = VulnerabilityDatabase.get_summary()
    print("=" * 60)
    print("SHELLOCKOLM VULNERABILITY DATABASE")
    print("=" * 60)
    print(f"\nTotal CVEs: {summary['total_cves']}")
    print(f"  - CRITICAL: {summary['critical']}")
    print(f"  - HIGH: {summary['high']}")
    print(f"  - MEDIUM: {summary['medium']}")
    print(f"  - LOW: {summary['low']}")
    print(f"\nActive Exploitation: {summary['active_exploitation']}")
    print(f"CISA KEV: {summary['cisa_kev']}")
    print(f"Public PoC: {summary['public_poc']}")
    print(f"Malware Campaigns: {summary['malware_campaigns']}")
    print(f"\nBy Category:")
    for cat, count in summary['categories'].items():
        print(f"  - {cat}: {count}")

    print("\n" + "=" * 60)
    print("BUG BOUNTY HIGH-VALUE TARGETS")
    print("=" * 60)
    for vuln in VulnerabilityDatabase.get_bug_bounty_targets():
        print(f"\n{vuln.cve_id} ({vuln.cvss_score})")
        print(f"  {vuln.title}")
        print(f"  Packages: {', '.join(vuln.packages)}")
        print(f"  Difficulty: {vuln.exploit_difficulty.value}")
